# 請求書AIエージェント デモプロジェクト 詳細ドキュメント

## 📋 プロジェクト概要

このプロジェクトは、**LangGraph**と**FastAPI**を使用した請求書処理AIエージェントのデモアプリケーションです。異なる表記形式の請求書（A/B/C）を正規化し、別システムへの入力フォームに1項目ずつ自動入力する「作業してる感」を可視化するデモです。

### 主な特徴

- **OCR/LLMなしのデモ版**: 事前抽出済みJSONデータを使用（後でTextract/Bedrockに差し替え可能）
- **リアルタイムストリーミング**: LangGraphのイベントをSSE（Server-Sent Events）で配信
- **視覚的な入力アニメーション**: フロントエンドで1文字ずつタイプ入力するアニメーション
- **表記ゆれの吸収**: 異なる形式の請求書（日本語/英語混在、日付形式の違いなど）を統一フォーマットに正規化

---

## 🏗️ アーキテクチャ

```
┌─────────────────┐
│   Frontend      │
│  (React + Vite) │
│                 │
│  - 請求書表示    │
│  - 指示入力      │
│  - ログ表示      │
│  - フォーム入力  │
└────────┬────────┘
         │ SSE (EventSource)
         │ /run?user_text=...
         ▼
┌─────────────────┐
│   Backend       │
│ (FastAPI)       │
│                 │
│  - LangGraph    │
│  - ストリーミング│
│  - CORS設定      │
└─────────────────┘
```

### データフロー

1. **ユーザー入力**: フロントエンドで「資料Aを入力して」などの指示を入力
2. **SSE接続**: フロントエンドが`/run`エンドポイントにEventSourceで接続
3. **LangGraph実行**: バックエンドでLangGraphが以下のノードを順次実行
   - `pick_doc`: ユーザー指示から対象ドキュメント（A/B/C）を決定
   - `load_or_extract`: 請求書データを読み込み（デモでは事前抽出データ）
   - `make_plan`: 別システム項目へのマッピング計画を作成
   - `stream_fill`: 1項目ずつ`fill`イベントをストリーミング
4. **リアルタイム更新**: フロントエンドがイベントを受信し、ログ表示とフォーム入力アニメーションを実行

---

## 📁 プロジェクト構造

```
invoice-agent-demo/
├── backend/
│   ├── app.py              # FastAPI + LangGraph メインアプリケーション
│   └── requirements.txt    # Python依存パッケージ
│
└── frontend/
    ├── index.html          # HTMLエントリーポイント
    ├── package.json        # Node.js依存パッケージ
    ├── vite.config.js      # Vite設定（プロキシ設定含む）
    └── src/
        ├── main.jsx        # Reactエントリーポイント
        ├── App.jsx         # メインコンポーネント
        ├── invoices.js     # 請求書A/B/Cのテキストデータ
        └── styles.css      # スタイルシート
```

---

## 📄 ファイル詳細

### バックエンド

#### `backend/app.py`

FastAPIアプリケーションとLangGraphフローの実装。

**主要コンポーネント:**

1. **PREBUILT**: デモ用の事前抽出済み請求書データ（A/B/C）
   - 各請求書の正規化済みデータ（取引先名、請求書番号、日付、金額など）
   - 実際の運用では、ここをOCR/LLM処理に置き換え

2. **State (TypedDict)**: LangGraphの状態管理
   ```python
   class State(TypedDict, total=False):
       user_text: str          # ユーザー入力テキスト
       doc_id: str             # 選択されたドキュメントID (A/B/C)
       normalized: Dict        # 正規化済み請求書データ
       fill_plan: List[Dict]   # 入力計画（フィールドと値のリスト）
   ```

3. **LangGraphノード:**
   - `pick_doc()`: ユーザー指示から対象ドキュメントを決定（A/B/Cの文字列検索）
   - `load_or_extract()`: 請求書データを読み込み、正規化ログを出力
   - `make_plan()`: 別システム項目へのマッピング計画を作成
   - `stream_fill()`: 1項目ずつ`fill`イベントをストリーミング

4. **APIエンドポイント:**
   - `GET /run?user_text=...`: SSEストリーミングでLangGraphを実行
   - `GET /health`: ヘルスチェック

**ストリーミング形式:**
```json
{"type": "log", "message": "対象ドキュメントを決定: A"}
{"type": "fill", "field": "vendor_name", "value": "ABC商事"}
```

#### `backend/requirements.txt`

Python依存パッケージ:
- `fastapi>=0.110`: Webフレームワーク
- `uvicorn[standard]>=0.27`: ASGIサーバー
- `langgraph>=0.2`: LangGraphライブラリ

---

### フロントエンド

#### `frontend/src/App.jsx`

メインReactコンポーネント。3カラムレイアウトで構成:

1. **左カラム: 請求書プレビュー**
   - タブでA/B/Cを切り替え
   - 請求書のテキストを表示（ダークテーマ）

2. **中央カラム: 指示入力とログ**
   - テキストエリアで指示を入力
   - チップボタン（「Aを入力」「Bを入力」「Cを入力」）でクイック入力
   - 実行/停止ボタン
   - 実行ログをリアルタイム表示

3. **右カラム: 別システム画面モック**
   - 7つの入力フィールド（取引先名、請求書番号、請求日、支払期日、小計、消費税、合計）
   - アクティブなフィールドはハイライト表示
   - 1文字ずつタイプ入力するアニメーション

**主要機能:**

- `typeInto()`: 文字列を1文字ずつタイプ入力するアニメーション関数
- `handleFill()`: `fill`イベントを受信し、フィールドにタイプ入力
- `run()`: EventSourceでSSE接続を開始し、イベントを処理
- キュー管理: `fill`イベントが複数来ても順序通りにアニメーション

#### `frontend/src/invoices.js`

請求書A/B/Cのテキストデータ（デモ用）:
- **A**: 日本語形式（ABC商事）
- **B**: 英語混在形式（さくら部品株式会社）
- **C**: 英語形式（TOYO INDUSTRIES）

各請求書は異なる表記形式（日付形式、金額表記、フィールド名など）を持ち、正規化の必要性を示す。

#### `frontend/src/styles.css`

モダンなUIデザイン:
- 3カラムグリッドレイアウト
- カードベースのデザイン
- ダークテーマの請求書プレビュー
- アクティブフィールドのハイライト（ボーダーとシャドウ）
- レスポンシブなスタイリング

#### `frontend/vite.config.js`

Vite設定:
- Reactプラグイン
- プロキシ設定: `/run`と`/health`を`http://127.0.0.1:8000`にプロキシ

#### `frontend/package.json`

依存パッケージ:
- `react ^18.2.0`: Reactライブラリ
- `react-dom ^18.2.0`: React DOM
- `@vitejs/plugin-react ^4.2.0`: Vite Reactプラグイン
- `vite ^5.0.0`: ビルドツール

---

## 🚀 セットアップ手順

### 前提条件

- Node.js 18+
- Python 3.11+
- Cursor（または任意のエディタ）

### バックエンドのセットアップ

```bash
# バックエンドディレクトリに移動
cd backend

# 仮想環境を作成
python -m venv .venv

# 仮想環境をアクティベート
# Windows (PowerShell)
.venv\Scripts\Activate.ps1
# macOS/Linux
source .venv/bin/activate

# 依存パッケージをインストール
pip install -r requirements.txt

# サーバーを起動
uvicorn app:app --reload --port 8000
```

**動作確認:**
ブラウザで `http://127.0.0.1:8000/health` にアクセスし、`{"ok":true}` が返ることを確認。

### フロントエンドのセットアップ

```bash
# フロントエンドディレクトリに移動（別ターミナル）
cd frontend

# 依存パッケージをインストール
npm install

# 開発サーバーを起動
npm run dev
```

**動作確認:**
ブラウザで `http://localhost:5173` を開く。

---

## 💡 使用方法

### 基本的な使い方

1. **請求書の確認**
   - 左側のタブ（A/B/C）をクリックして、異なる表記形式の請求書を確認

2. **指示の入力**
   - 中央のテキストエリアに「資料Aを入力して」などと入力
   - または、薄いチップボタン（「Aを入力」「Bを入力」「Cを入力」）をクリック

3. **実行**
   - 「実行」ボタンをクリック
   - 中央のログエリアに進捗が表示される
   - 右側のフォームに1項目ずつ入力される様子を確認

4. **停止**
   - 実行中に「停止」ボタンをクリックすると処理を中断

### デモの見どころ

- **表記ゆれの吸収**: A/B/Cで異なる表記形式（日付、金額、フィールド名）が統一フォーマットに正規化される
- **リアルタイムログ**: OCR→正規化→マッピング→入力の各工程がログで確認できる
- **視覚的な入力アニメーション**: 1文字ずつタイプ入力する様子で「作業してる感」を演出
- **アクティブフィールドのハイライト**: 現在入力中のフィールドが視覚的に強調される

---

## 🔧 技術スタック

### バックエンド
- **FastAPI**: モダンなPython Webフレームワーク
- **LangGraph**: 状態管理とワークフロー実行
- **Server-Sent Events (SSE)**: リアルタイムストリーミング
- **Uvicorn**: ASGIサーバー

### フロントエンド
- **React 18**: UIライブラリ
- **Vite**: 高速なビルドツールと開発サーバー
- **EventSource API**: SSEクライアント実装
- **CSS**: モダンなスタイリング（グリッド、カードデザイン）

---

## 🔄 データフロー詳細

### 1. ユーザー指示の処理

```
ユーザー入力: "資料Aを入力して"
    ↓
pick_doc() ノード
    ↓
"A"を含む → doc_id = "A"
    ↓
ストリーム: {"type": "log", "message": "対象ドキュメントを決定: A"}
```

### 2. 請求書データの読み込み

```
load_or_extract() ノード
    ↓
PREBUILT["A"] を取得
    ↓
ストリーム:
  - {"type": "log", "message": "請求書Aを読み取り中…"}
  - {"type": "log", "message": "項目候補を抽出中…"}
  - {"type": "log", "message": "表記ゆれを正規化中…"}
    ↓
normalized = {
  "vendor_name": "ABC商事",
  "invoice_no": "INV-A-001",
  ...
}
```

### 3. 入力計画の作成

```
make_plan() ノード
    ↓
TARGET_FIELDS_ORDER に従って計画を作成
    ↓
fill_plan = [
  {"type": "fill", "field": "vendor_name", "value": "ABC商事"},
  {"type": "fill", "field": "invoice_no", "value": "INV-A-001"},
  ...
]
```

### 4. ストリーミング入力

```
stream_fill() ノード
    ↓
各 fill イベントを順次ストリーミング
    ↓
フロントエンドが受信
    ↓
handleFill() でタイプ入力アニメーション
```

---

## 🎯 今後の拡張可能性

### OCR/LLM統合

現在は事前抽出データ（`PREBUILT`）を使用していますが、以下のように置き換え可能:

1. **AWS Textract**: PDF請求書からテキスト抽出
2. **AWS Bedrock**: LLMで構造化データ抽出と正規化
3. **LangGraphノード拡張**: `load_or_extract()`内でOCR/LLMを呼び出し

### 機能拡張

- **複数請求書の一括処理**: 複数の請求書を順次処理
- **エラーハンドリング**: 抽出失敗時のリトライやフォールバック
- **バリデーション**: 抽出データの妥当性チェック
- **履歴管理**: 処理済み請求書の履歴表示
- **実際のシステム連携**: モックフォームではなく、実際のAPIに送信

### UI改善

- **ドラッグ&ドロップ**: PDFファイルを直接アップロード
- **進捗バー**: 処理進捗の視覚化
- **エラー表示**: エラー時の分かりやすい表示
- **レスポンシブ対応**: モバイルデバイス対応

---

## 📝 注意事項

### セキュリティ

- 現在のCORS設定はローカル開発用（`localhost:5173`のみ許可）
- 本番環境では適切なCORS設定と認証が必要

### パフォーマンス

- デモ版では処理が軽量だが、OCR/LLM統合時はレスポンス時間に注意
- SSE接続のタイムアウト設定を検討

### データ管理

- 現在はメモリ内でデータを保持（再起動で消える）
- 本番環境ではデータベースやストレージへの永続化が必要

---

## 🐛 トラブルシューティング

### バックエンドが起動しない

- Python仮想環境がアクティベートされているか確認
- ポート8000が使用中でないか確認
- `pip install -r requirements.txt` が正常に完了したか確認

### フロントエンドがバックエンドに接続できない

- バックエンドが`http://127.0.0.1:8000`で起動しているか確認
- ブラウザのコンソールでエラーを確認
- CORS設定が正しいか確認

### SSEイベントが受信されない

- ブラウザの開発者ツールでネットワークタブを確認
- `/run`エンドポイントが正常に応答しているか確認
- EventSourceのエラーハンドラでエラー内容を確認

---

## 📚 参考資料

- [FastAPI公式ドキュメント](https://fastapi.tiangolo.com/)
- [LangGraph公式ドキュメント](https://langchain-ai.github.io/langgraph/)
- [React公式ドキュメント](https://react.dev/)
- [Vite公式ドキュメント](https://vitejs.dev/)

---

## 📅 更新履歴

- **2025-12-22**: 初版作成（OCR/LLMなしデモ版）

---

## 👤 作成者

請求書AIエージェント デモプロジェクト

---

**このドキュメントは、プロジェクトの現状を詳細に記述したものです。機能追加や変更があった場合は、このドキュメントも更新してください。**

